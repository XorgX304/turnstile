#!/usr/bin/env node
'use strict';

const Errors = require('../lib/errors');
const SUPPORTED_ALGORITHMS = ['SHA256', 'SHA512'];

require('../lib/config');
if (['SHA256', 'SHA512'].filter((a) => a === Config.get('local:algorithm').toUpperCase()).length === 0) {
  const message = `Turnstile currently supports the following encryption algorithms: ${SUPPORTED_ALGORITHMS.join(', ')}`;

  throw new Errors.UnsupportedAlgorithmError(message, Config.get('local:algorithm').toUpperCase());
}

require('../lib/log');

const app = require('../lib/control/layer').create();
const server = require('http').createServer(app);

// Only attach the correlation ID middleware if it's enabled
if (Config.get('correlation:enable')) {
  app.use(require('../lib/control/correlation').create(Config.get('correlation')));
}

app.use(require('../lib/provider/local').authn(Config.get('local')));
app.use(require('../lib/control/forward').create(Config.get('service')));

server.listen(
  Config.get('listen:port'),
  Config.get('listen:bind'),
  () => Log.info(`Listening on ${Config.get('listen:bind')}:${Config.get('listen:port')}`)
);
